<div class="d-flex justify-content-between align-items-center">
  <h2 class="tui-text_h4">Chi tiết lịch học</h2>
  <ng-container *ngrxLet="justRequestedSchedule$ as justRequestedSchedule">
    <button
      tuiButton
      *ngIf="context.data.FixedSchedules?.length"
      (click)="onShowHistory()"
      [icon]="IconConstant.historyLarge"
      appearance="outline"
      class="tui-form__button"
    >
      Lịch sử thay đổi giờ giảng
    </button>
  </ng-container>
</div>

<form
  [formGroup]="form"
  *ngrxLet="requestingChangeSchedule$ as requestingChangeSchedule"
>
  <div class="tui-form__row">
    <tui-input [readOnly]="true" formControlName="subject"> Lớp </tui-input>
  </div>
  <div class="tui-form__row">
    <tui-input [readOnly]="true" formControlName="location">
      Phòng học
    </tui-input>
  </div>
  <div class="tui-form__row tui-form__row_multi-fields">
    <div class="tui-form__multi-field">
      <tui-input-date-time [readOnly]="true" formControlName="start">
        Bắt đầu
      </tui-input-date-time>
    </div>
    <div class="tui-form__multi-field">
      <tui-input-date-time [readOnly]="true" formControlName="end">
        Kết thúc
      </tui-input-date-time>
    </div>
  </div>
  <div *ngIf="form.controls['people'].value !== 'self'" class="tui-form__row">
    <tui-input [readOnly]="true" formControlName="people">
      Giảng viên
    </tui-input>
  </div>

  <tui-expand [expanded]="!requestingChangeSchedule" formGroupName="change">
    <div></div>
    <div class="tui-form__row">
      <tui-text-area
        formControlName="note"
        [tuiTextfieldMaxLength]="noteMaxLength"
      >
        Ghi chú
      </tui-text-area>
      <tui-field-error formControlName="note"></tui-field-error>
    </div>
  </tui-expand>

  <ng-container *ngrxLet="justRequestedSchedule$ as justRequestedSchedule">
    <ng-container
      *tssVar="justRequestedSchedule || requestedChangeSchedule as schedule"
    >
      <div *ngIf="schedule" class="tui-form__row">
        <ng-container *ngrxLet="cancelStatus$ as cancelStatus">
          <tui-loader
            [showLoader]="cancelStatus === EApiStatus.loading"
            [overlay]="true"
          >
            <tui-notification status="info">
              Ca học này đang được yêu cầu chuyển tới ca
              {{ schedule.newShift }}, ngày
              {{ schedule.newDate | date: "dd-MM-Y" }}
              {{ schedule.newIdRoom ? "tại " + schedule.newIdRoom : "" }}
              <br />
              <button
                tuiButton
                (click)="cancelRequest$.next()"
                appearance="accent"
                size="xs"
                class="cancel-request"
              >
                Hủy yêu cầu này
              </button>
            </tui-notification>
          </tui-loader>
        </ng-container>
      </div>
    </ng-container>
  </ng-container>

  <tui-expand [expanded]="requestingChangeSchedule">
    <h3 class="tui-form__header">
      {{ isPersonal ? "Yêu cầu thay đổi lịch giảng" : "Thay đổi lịch giảng" }}
    </h3>

    <div *ngIf="isPersonal" class="tui-form__row">
      <tui-checkbox-labeled
        [(ngModel)]="requestChangeToUndeterminedDay"
        [ngModelOptions]="{ standalone: true }"
        size="l"
      >
        Chưa xác định được ngày dạy
      </tui-checkbox-labeled>
    </div>
    <div class="tui-form__row"></div>

    <tui-expand
      [expanded]="!requestChangeToUndeterminedDay"
      formGroupName="request"
    >
      <div [tuiTextfieldCleaner]="true" class="tui-form__row">
        <tui-input-date
          (ngModelChange)="changeRequest$.next()"
          formControlName="date"
        >
          Chọn ngày học
        </tui-input-date>
        <tui-field-error formControlName="date"></tui-field-error>
      </div>
      <div class="tui-form__row">
        <tui-select
          (ngModelChange)="changeRequest$.next()"
          [valueContent]="shiftSelectContent"
          formControlName="shift"
        >
          Chọn ca học:
          <tui-data-list *tuiDataList>
            <tui-opt-group>
              <button
                tuiOption
                *ngFor="let shiftKey of shiftKeys"
                [value]="shiftKey"
              >
                {{ shiftKey | shift }}
              </button>
            </tui-opt-group>
          </tui-data-list>
        </tui-select>
      </div>
      <div *ngIf="isPersonal" class="tui-form__row">
        <tui-select [valueContent]="studyTypeContent" formControlName="online">
          Chọn hình thức học:
          <ng-template tuiDataList>
            <tui-data-list>
              <button tuiOption [value]="true">Phòng học trực tuyến</button>
              <button tuiOption [value]="false">Học trực tiếp</button>
            </tui-data-list>
          </ng-template>
        </tui-select>
      </div>
      <div *ngIf="!isPersonal" class="tui-form__row">
        <tui-combo-box
          *ngrxLet="rooms$ as rooms"
          formControlName="room"
          class="tui-form__row"
        >
          Nhập phòng
          <input tuiTextfield />
          <tui-data-list-wrapper
            *tuiDataList
            [items]="rooms | filter: 'PTTT' | tuiFilterByInput"
          >
          </tui-data-list-wrapper>
        </tui-combo-box>
        <tui-field-error formControlName="room"></tui-field-error>
      </div>
      <div *ngIf="isPersonal" class="tui-form__row">
        <tui-text-area
          formControlName="reason"
          [tuiTextfieldMaxLength]="reasonMaxLength"
        >
          Lý do
        </tui-text-area>
      </div>
      <div class="tui-form__row">
        <tss-study-editor-dialog-search-schedule
          [sameData]="requestControl.errors?.sameValue || false"
          [hadReason]="
            requestControl.controls['reason'].errors?.required !== true
          "
        ></tss-study-editor-dialog-search-schedule>
      </div>
    </tui-expand>

    <tui-expand
      [expanded]="requestChangeToUndeterminedDay"
      formGroupName="requestIntend"
    >
      <div class="tui-form__row">
        <tui-text-area
          formControlName="intendTime"
          [tuiTextfieldMaxLength]="intendTimeMaxLength"
        >
          Nhập thời gian dự định
        </tui-text-area>
      </div>
    </tui-expand>
    <div class="tui-form__row">
      <tui-text-area
        formControlName="reason"
        [tuiTextfieldMaxLength]="reasonMaxLength"
      >
        Lý do
      </tui-text-area>
    </div>
  </tui-expand>

  <div
    *ngrxLet="requestStatus$ as requestStatus"
    class="btn-group d-flex justify-content-between"
  >
    <ng-container *ngrxLet="changeStatus$ as changeStatus">
      <div
        *ngIf="validRequestChangeSchedule"
        class="tui-form__buttons tui-form__buttons_align_start"
      >
        <ng-container
          *ngrxLet="justRequestedSchedule$ as justRequestedSchedule"
        >
          <ng-container
            *ngIf="!requestedChangeSchedule && !justRequestedSchedule"
          >
            <ng-container *ngrxLet="searchStatus$ as searchStatus">
              <button
                tuiButton
                *ngIf="
                  requestingChangeSchedule && isPersonal;
                  else changeSchedule
                "
                (click)="submitRequestChange$.next()"
                [showLoader]="requestStatus === EApiStatus.loading"
                [disabled]="
                  (!requestChangeToUndeterminedDay && requestControl.invalid) ||
                  (requestChangeToUndeterminedDay &&
                    requestIntendControl.invalid) ||
                  searchStatus === EApiStatus.loading
                "
                class="tui-form__button"
              >
                Gửi yêu cầu
              </button>
              <ng-template #changeSchedule>
                <button
                  tuiButton
                  *ngIf="requestingChangeSchedule && !isPersonal; else request"
                  (click)="submitChange$.next()"
                  [showLoader]="changeStatus === EApiStatus.loading"
                  [disabled]="
                    requestControl.invalid ||
                    searchStatus === EApiStatus.loading
                  "
                  class="tui-form__button"
                >
                  Xác nhận thay đổi
                </button>
              </ng-template>
            </ng-container>
          </ng-container>
        </ng-container>
        <ng-template #request>
          <button
            tuiButton
            (click)="toggleRequestArea(true)"
            appearance="secondary"
            class="tui-form__button"
          >
            {{
              isPersonal ? "Yêu cầu thay đổi lịch giảng" : "Thay đổi lịch giảng"
            }}
          </button>
        </ng-template>
      </div>
      <div class="tui-form__buttons tui-form__buttons_align_end">
        <button
          tuiButton
          *ngIf="requestingChangeSchedule; else notEditing"
          (click)="toggleRequestArea(false)"
          [disabled]="
            requestStatus === EApiStatus.loading ||
            changeStatus === EApiStatus.loading
          "
          appearance="outline"
          class="tui-form__button"
        >
          Hủy
        </button>
        <ng-template #notEditing>
          <ng-container *ngrxLet="updateStatus$ as updateStatus">
            <button
              tuiButton
              (click)="onUpdate()"
              [showLoader]="updateStatus === EApiStatus.loading"
              [disabled]="form.controls['change'].invalid"
              class="tui-form__button"
            >
              Lưu
            </button>
          </ng-container>
          <button
            tuiButton
            (click)="cancel$.next()"
            appearance="outline"
            class="tui-form__button"
          >
            Đóng
          </button>
        </ng-template>
      </div>
    </ng-container>
  </div>
</form>

<ng-template #shiftSelectContent let-shiftKey>
  {{ shiftKey | shift }}
</ng-template>

<ng-template #studyTypeContent let-online>
  {{ online ? "Phòng học trực tuyến" : "Học trực tiếp" }}
</ng-template>
