<tss-study-editor-header
  [fixedSchedules]="context.data.FixedSchedules"
></tss-study-editor-header>

<form
  [formGroup]="form"
  *ngrxLet="requestingChangeSchedule$ as requestingChangeSchedule"
>
  <div class="tui-form__row">
    <tui-input [readOnly]="true" formControlName="subject"> Lớp </tui-input>
  </div>
  <div class="tui-form__row">
    <tui-input [readOnly]="true" formControlName="location">
      Phòng học
    </tui-input>
  </div>
  <div class="tui-form__row tui-form__row_multi-fields">
    <div class="tui-form__multi-field">
      <tui-input-date-time [readOnly]="true" formControlName="start">
        Bắt đầu
      </tui-input-date-time>
    </div>
    <div class="tui-form__multi-field">
      <tui-input-date-time [readOnly]="true" formControlName="end">
        Kết thúc
      </tui-input-date-time>
    </div>
  </div>
  <div *ngIf="form.controls['people'].value !== 'self'" class="tui-form__row">
    <tui-input [readOnly]="true" formControlName="people">
      Giảng viên
    </tui-input>
  </div>

  <tui-expand [expanded]="!requestingChangeSchedule" formGroupName="change">
    <div></div>
    <div class="tui-form__row">
      <tui-text-area
        formControlName="note"
        [tuiTextfieldMaxLength]="CoreConstant.NOTE_MAX_LENGTH"
      >
        Ghi chú
      </tui-text-area>
      <tui-field-error formControlName="note"></tui-field-error>
    </div>
  </tui-expand>

  <ng-container *ngrxLet="justRequestedSchedule$ as justRequestedSchedule">
    <ng-container
      *tssVar="justRequestedSchedule || requestedChangeSchedule as schedule"
    >
      <div *ngIf="schedule" class="tui-form__row">
        <ng-container *ngrxLet="cancelStatus$ as cancelStatus">
          <tui-loader
            [showLoader]="cancelStatus === EApiStatus.loading"
            [overlay]="true"
          >
            <tui-notification status="info">
              Ca học này đang được yêu cầu chuyển tới
              <ng-container *ngIf="schedule.intendTime; else noIntend">
                {{ schedule.intendTime }}
              </ng-container>
              <ng-template #noIntend>
                ca {{ schedule.newShift }}, ngày
                {{ schedule.newDate | date: "dd-MM-Y" }}
                {{ schedule.newIdRoom ? "tại " + schedule.newIdRoom : "" }}
              </ng-template>
              <br />
              <button
                tuiButton
                (click)="cancelRequest$.next()"
                appearance="accent"
                size="xs"
                class="cancel-request"
              >
                Hủy yêu cầu này
              </button>
            </tui-notification>
          </tui-loader>
        </ng-container>
      </div>
    </ng-container>
  </ng-container>

  <tui-expand [expanded]="requestingChangeSchedule">
    <h3 class="tui-form__header">
      {{ isPersonal ? "Yêu cầu thay đổi lịch giảng" : "Thay đổi lịch giảng" }}
    </h3>

    <div *ngIf="isPersonal" class="tui-form__row">
      <tui-checkbox-labeled
        [(ngModel)]="requestChangeToUndeterminedDay"
        [ngModelOptions]="{ standalone: true }"
        size="l"
      >
        Chưa xác định được ngày dạy
      </tui-checkbox-labeled>
    </div>
    <div class="tui-form__row"></div>

    <tui-expand
      [expanded]="!requestChangeToUndeterminedDay"
      formGroupName="request"
    >
      <tss-study-editor-request-change
        [isPersonal]="isPersonal"
        [people]="context.data.People"
      ></tss-study-editor-request-change>
    </tui-expand>

    <tui-expand
      [expanded]="requestChangeToUndeterminedDay"
      formGroupName="requestIntend"
    >
      <tss-study-editor-request-change-intend></tss-study-editor-request-change-intend>
    </tui-expand>
  </tui-expand>

  <div
    *ngrxLet="requestStatus$ as requestStatus"
    class="btn-group d-flex justify-content-between"
  >
    <ng-container *ngrxLet="changeStatus$ as changeStatus">
      <!-- Left buttons -->
      <tss-study-editor-buttons-left
        [(changed)]="changed"
        [idSchedule]="context.data.Id"
        [validRequestChangeSchedule]="validRequestChangeSchedule"
        [requestedChangeSchedule]="requestedChangeSchedule"
        [isPersonal]="isPersonal"
        [requestChangeToUndeterminedDay]="requestChangeToUndeterminedDay"
      ></tss-study-editor-buttons-left>

      <!-- Right buttons -->
      <tss-study-editor-buttons-right
        (cancel)="cancel$.next()"
        [idSchedule]="context.data.Id"
      ></tss-study-editor-buttons-right>
    </ng-container>
  </div>
</form>
